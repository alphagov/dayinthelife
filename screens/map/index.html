<!doctype html>

<title>uk map</title>
<style>
  .map path {
    fill: #333;
    stroke: #555;
  }
  .map circle {
    fill: #fff;
  }
  .pullout path {
    fill: none;
    stroke: #f00;
    stroke-width: 1;
  }

  #overlay {
    position: absolute;
    top: 0;
    left: 0;
  }
  #overlay p {
    position: relative;
    border: 1px solid #f00;
    color: #fff;
    background: #333;
    width: 150px;
    height: 75px;
    font: 16px helvetica;
    padding: 10px;
  }
  body {
    background: #333;
  }
</style>

<svg id="map" width="600" height="500"></svg>
<div id="overlay"></div>

<script src="./d3.v3.min.js"></script>
<script src="./topojson.v0.min.js"></script>
<script>

  var svg = d3.select('#map');
  var overlay = d3.select('#overlay');

  var map = svg.append("g").attr("class", "map");
  var projection = d3.geo.albers();
      projection.center([-2,54]);       // center long and lat of the world
      projection.translate([300, 250]); // center pixel of the svg
      projection.rotate([0,0]);         // rotation of the graph
      projection.scale(2500);           // scale of the graph

  var path = d3.geo.path().projection(projection);
  d3.json('uk2.json', function(json) {
    map.append('path')
    .datum(topojson.object(json, json.objects.subunits))
    .attr('d', path);
  });
  d3.json('users.json', function(json) {
    userMap.allUsers = json;
    userMap.init();
  });

  var userMap = {
    userCount: 0,
    allUsers: [],
    displayedUsers: [],

    showNextUser: function(){
      userMap.userCount = userMap.userCount + 1;
      if(userMap.userCount >= userMap.allUsers.length){ userMap.userCount = 0; }

      if(userMap.readyForPullout === true){
        userMap.addPulloutUser(userMap.allUsers[userMap.userCount]);
      } else {
        userMap.displayedUsers.push(userMap.allUsers[userMap.userCount]);
      }

      if(userMap.displayedUsers.length > 40){
        userMap.displayedUsers.shift();
      }
      userMap.update()
    },
    update: function(){
      // Add data
      var circle = map.selectAll('circle')
        .data(userMap.displayedUsers, function(d){ return ''+ d[0] + d[1]; });

      // Add new elements 
      circle.enter().insert('circle')
          .attr('cx', function(d){ return projection([ d[1], d[0] ])[0] })
          .attr('cy', function(d){ return projection([ d[1], d[0] ])[1] })
          .attr("r", 5)
          .attr('fill-opacity', '1.0')
        .transition()
          .duration(400)
          .attr("r", 2)
          .attr('fill-opacity', '0.4')

      // Remove old elements
      circle.exit()
        .transition()
          .attr('fill-opacity', '0')
          .remove();
    },
    addPulloutUser: function(user){
      userMap.readyForPullout = false;
      var pullout = svg.append('g').attr('class', 'pullout');
      var userPixels = projection([ user[1], user[0] ]),
          data = [ userPixels, [ 450, userPixels[1]], [ 450, 200 ] ];

      var circle = pullout.append('circle')
          .attr('cx', userPixels[0])
          .attr('cy', userPixels[1])
          .attr("r", 5)
          .attr('fill', '#f00')
        .transition()
          .duration(400)
          .attr("r", 2)

      var line = d3.svg.line()
        .x(function(d) {return d[0];})
        .y(function(d) {return d[1];})

      var path = pullout.append("path")
          .attr("d", line(data));

      var infoBox;
      var totalLength = path.node().getTotalLength();

      path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
        .transition()
          .duration(500)
          .ease("linear")
          .attr("stroke-dashoffset", 0)
        .each("end", function(){
          infoBox = overlay.append('p')
          .text(randomTitle())
          .attr('style', "left: 450px; top: 150px")
        });
      
      window.setTimeout(function(){
        pullout.remove();
        infoBox.remove();

        userMap.readyForPullout = true;

      }, 3e3);


    },
    init: function(){
      window.setInterval(userMap.showNextUser, 250);
      window.setTimeout(function(){
        userMap.readyForPullout = true;
      }, 2e3);
    }
  };


  svg.on("click", function() {
    p = projection.invert(d3.mouse(this));
    console.log(p);
  });


  function randomTitle(){
    var pageTitles = ['Find a job with Universal Jobmatch', 'Welcome to GOV.UK', 'Contact Jobcentre Plus', 'Car tax (vehicle licence)', 'UK bank holidays', 'Finding a job', 'Jobseeker\'s Allowance', 'State Pension calculator', 'Passports', 'National Minimum Wage rates', 'Cold Weather Payment', 'Driving licences', 'Book your practical driving or riding test', 'Renew or replace your adult passport', 'Calculate vehicle tax rates', 'Book your driving theory test', 'Passport fees', 'Car tax and tax discs', 'Change the address on your driving licence', 'Practise your driving theory test', 'Ministry of Defence - Inside Government', 'Student finance', 'Change the date of your practical test', 'Benefits adviser', 'Apply for your first provisional driving licence', 'Make a SORN (Statutory Off Road Notification)', 'Disability Living Allowance (DLA)', 'Estimate your High Income Child Benefit Tax Charge', 'Driving, transport and travel', 'Benefits', 'Contact DVLA', 'Replace a lost, stolen, damaged or destroyed driving licence', 'Get a State Pension statement', 'Employment and Support Allowance (ESA)', 'The basic State Pension', 'State Pension', 'Criminal Records Bureau (CRB) checks (Disclosure and Barring Service)', 'Housing Benefit', 'MOT and vehicle insurance', 'Get vehicle information from DVLA', 'Renew the photo on your driving licence', 'Child Benefit', 'Calculate your statutory redundancy pay', 'Holiday entitlement', 'Council Tax', 'Renew your driving licence if you\'re 70 or over', 'Driving tests, motorcycle tests and learning to drive', 'Apply for, renew or update a UK passport online', 'Income Support', 'Check the MOT status of a vehicle'];
    return pageTitles[Math.round(Math.random()*pageTitles.length)];
  }

</script>
